<html>
  <head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script src="http://code.highcharts.com/highcharts.js" type="text/javascript"></script>
    <script src="http://code.highcharts.com/modules/exporting.js" type="text/javascript"></script>
    <script type="text/javascript"> 

/*Declare variables*/
var data_in;
var chart;
var varinfo = {
	name:[]
	}

var options = {
    xAxis: {type: 'datetime',},
    legend: {layout: 'horizontal',align: 'center',verticalAlign: 'bottom',},
};

/*Obtain all the data at once from the server*/
$.ajax({
 url: 'FetchStationData.php',
 success: function(data){
 DATA = eval('(' + data + ')');
 },
 async: false,
 cache: false
});	

$(function() {
 LoadInitialInfo();
 $('#container').highcharts(options);
 var chart = $('#container').highcharts(); 
});

function UpdateChart(variable){

 chart = $('#container').highcharts();
 if (chart.get(variable) != undefined){ 
  chart.get(variable).remove();
  //Update y-axis limits
  min_array = []
  max_array = []
  units = DATA["VARIABLES"][variable]["units"];
  //Find current mins and maxs
  flag_series_exists = false;
  for (series in chart.series){
   flag_series_exists = true;
   if (chart.series[series].yAxis.options.id == units){
    min_array.push(DATA["VARIABLES"][chart.series[series].name]["minval"]);
    max_array.push(DATA["VARIABLES"][chart.series[series].name]["maxval"]);
    }
  }
  //If we don't have any more series then erase the axis
  if (flag_series_exists == false){
   chart.get(units).remove();
  };
  yAxis_min = Math.min.apply(Math,min_array)
  yAxis_max = Math.max.apply(Math,max_array)
  //Set new limits
  for (yAxis in chart.options.yAxis){
   if (chart.options.yAxis[yAxis].id == units){
    chart.yAxis[yAxis].setExtremes(yAxis_min,yAxis_max);
    break
   };
  };
 }
 else{
  VARIABLE = DATA["VARIABLES"][variable];
  units = VARIABLE["units"]
  dataset = VARIABLE["dataset"]
  maxval = VARIABLE["maxval"]
  minval = VARIABLE["minval"]
  //Determine y axis limits
  min_array = [VARIABLE["minval"],]
  max_array = [VARIABLE["maxval"],]
  flag_add_axis = true;
  //Find current mins and maxs
  for (series in chart.series){
   if (chart.series[series].yAxis.options.id == units){
    flag_add_axis = false;
    min_array.push(DATA["VARIABLES"][chart.series[series].name]["minval"]);
    max_array.push(DATA["VARIABLES"][chart.series[series].name]["maxval"]);
    }
  }
  yAxis_min = Math.min.apply(Math,min_array)
  yAxis_max = Math.max.apply(Math,max_array)
  //Define the new series
  var series = {
   color: ($('input:radio[name=color]:checked').val()),
   type: ($('input:radio[name=type]:checked').val()),
   data: VARIABLE["data"],
   name: variable,
   id: variable,
   pointInterval: DATA["TIME"]["pointInterval"],
   pointStart: Date.UTC(DATA["TIME"]["iyear"],DATA["TIME"]["imonth"]-1,DATA["TIME"]["iday"]),
   yAxis: units,
  };
  //Create the new axis if necessary
  if (flag_add_axis == true){
   var yAxis = {
    min: yAxis_min,
    max: yAxis_max,
    title: {text: units},
    name: variable,
    id: units
   }
   chart.addAxis(yAxis,false);
  }
  else{
   for (yAxis in chart.options.yAxis){
    if (chart.options.yAxis[yAxis].id == units){
     chart.yAxis[yAxis].setExtremes(yAxis_min,yAxis_max,false);
    };
   };
  };
  chart.addSeries(series,false);
  chart.redraw();
 };
};
$('input:radio[name=sex]:checked').val();

function LoadInitialInfo(){
 for (variable in DATA["VARIABLES"]){
  $('#series').append('<input type="checkbox" id="' + variable + '" onclick=UpdateChart("' + variable + '")>' + variable + ' ')
 }
 $('#series').append('<br><input type="submit" value="Request Data">')
 //var a = [2,4,5,6]
 //alert(Math.min.apply(Math,a))
};

function PrepareData(){
 chart = $('#container').highcharts();
 for (id in chart['options']['yAxis']){
  yAxis = chart['options']['yAxis'][id]
 }
}
  
    </script>
  </head>

  <body>
    <div id="container"></div>
    <form id="series" action="Point_Data_Request.php" method="post"></form>
    <!-- color -->
    color:
    <input type="radio" name="color" value="red" checked=checked>red
    <input type="radio" name="color" value="blue">blue
    <input type="radio" name="color" value="green">green
    <br>
    <!-- type -->
    type: 
    <input type="radio" name="type" value="line" checked=checked>line
    <input type="radio" name="type" value="spline">spline
    <input type="radio" name="type" value="area">area
    <input type="radio" name="type" value="areaspline">area spline
    <input type="radio" name="type" value="bar">bar
    <br>
    <!-- axis -->
    <!-- marker -->
    marker:
    <!--<input type="radio" name="type" value="yes" checked=checked>line
    <input type="radio" name="type" value="no">spline-->
  </body>
</html>
